// script.js - renders using the built-in 5x7 font (scaled)
// Appends attribution to copied & downloaded text.

const FONT = {
  "A":["01110","10001","10001","11111","10001","10001","10001"],
  "B":["11110","10001","10001","11110","10001","10001","11110"],
  "C":["01111","10000","10000","10000","10000","10000","01111"],
  "D":["11110","10001","10001","10001","10001","10001","11110"],
  "E":["11111","10000","10000","11110","10000","10000","11111"],
  "F":["11111","10000","10000","11110","10000","10000","00000"],
  "G":["01111","10000","10000","10011","10001","10001","01110"],
  "H":["10001","10001","10001","11111","10001","10001","10001"],
  "I":["01110","00100","00100","00100","00100","00100","01110"],
  "J":["00111","00010","00010","00010","10010","10010","01100"],
  "K":["10001","10010","10100","11000","10100","10010","10001"],
  "L":["10000","10000","10000","10000","10000","10000","11111"],
  "M":["10001","11011","10101","10101","10001","10001","10001"],
  "N":["10001","11001","10101","10011","10001","10001","10001"],
  "O":["01110","10001","10001","10001","10001","10001","01110"],
  "P":["11110","10001","10001","11110","10000","10000","00000"],
  "Q":["01110","10001","10001","10001","10101","10010","01101"],
  "R":["11110","10001","10001","11110","10100","10010","10001"],
  "S":["01111","10000","10000","01110","00001","00001","11110"],
  "T":["11111","00100","00100","00100","00100","00100","00100"],
  "U":["10001","10001","10001","10001","10001","10001","01110"],
  "V":["10001","10001","10001","10001","10001","01010","00100"],
  "W":["10001","10001","10001","10101","10101","11011","10001"],
  "X":["10001","10001","01010","00100","01010","10001","10001"],
  "Y":["10001","10001","01010","00100","00100","00100","00100"],
  "Z":["11111","00001","00010","00100","01000","10000","11111"],
  "0":["01110","10001","10011","10101","11001","10001","01110"],
  "1":["00100","01100","00100","00100","00100","00100","01110"],
  "2":["01110","10001","00001","00010","00100","01000","11111"],
  "3":["01110","10001","00001","00110","00001","10001","01110"],
  "4":["00010","00110","01010","10010","11111","00010","00010"],
  "5":["11111","10000","10000","11110","00001","10001","01110"],
  "6":["00110","01000","10000","11110","10001","10001","01110"],
  "7":["11111","00001","00010","00100","01000","01000","01000"],
  "8":["01110","10001","10001","01110","10001","10001","01110"],
  "9":["01110","10001","10001","01111","00001","00010","01100"],
  " ":["00000","00000","00000","00000","00000","00000","00000"],
  ".":["00000","00000","00000","00000","00000","01100","01100"],
  ",":["00000","00000","00000","00000","00000","01100","01000"],
  "!":["00100","00100","00100","00100","00100","00000","00100"],
  "?":["01110","10001","00001","00010","00100","00000","00100"],
  "-":["00000","00000","00000","11111","00000","00000","00000"],
  "'":["00100","00100","00000","00000","00000","00000","00000"],
  ":":["00000","01100","01100","00000","01100","01100","00000"]
};

const SIZE_PRESETS = { small:1, medium:2, large:4, huge:8 };

function render(text, draw="#", scale=1, spacing=1) {
  scale = Math.max(1, parseInt(scale, 10) || 1);
  spacing = Math.max(0, parseInt(spacing, 10) || 0);
  const rows = Array.from({length: 7 * scale}, () => "");
  const sep = " ".repeat(spacing);
  for (let ch of text) {
    let key = ch.toUpperCase();
    let bitmap = FONT[key];
    if (!bitmap) {
      bitmap = ["00000","00000","00000","00100","00000","00000","00000"];
    }
    for (let r = 0; r < bitmap.length; r++) {
      const rowPattern = bitmap[r];
      let outRow = "";
      for (let bit of rowPattern) {
        outRow += (bit === "1") ? draw.repeat(scale) : " ".repeat(scale);
      }
      for (let v=0; v<scale; v++){
        rows[r * scale + v] += outRow + sep;
      }
    }
  }
  return rows.map(r => r.replace(/\s+$/,"")).join("\n") + "\n";
}

// DOM bindings
const inputText = document.getElementById("inputText");
const drawChar = document.getElementById("drawChar");
const scaleInput = document.getElementById("scale");
const spacingInput = document.getElementById("spacing");
const renderBtn = document.getElementById("renderBtn");
const outputEl = document.getElementById("output");
const copyBtn = document.getElementById("copyBtn");
const downloadLink = document.getElementById("downloadLink");
const sizeSelect = document.getElementById("sizeSelect");

// Get author from SITE_CONFIG (set by index.html loader) or fallback
const SITE_CONFIG = window.SITE_CONFIG || {};
const AUTHOR = (SITE_CONFIG.author && String(SITE_CONFIG.author)) || "nathanpaulgeorge";
const ATTRIBUTION_LINE = `Generated by ASCII text generator by ${AUTHOR}`;

function syncSizeToScale(){
  const preset = sizeSelect.value;
  const presetScale = SIZE_PRESETS[preset] || 1;
  scaleInput.value = presetScale;
}

sizeSelect.addEventListener("change", () => {
  syncSizeToScale();
  doRender();
});

// initial sync
syncSizeToScale();

function doRender(){
  const text = inputText.value || "";
  const draw = (drawChar.value && drawChar.value[0]) || "#";
  const scale = parseInt(scaleInput.value,10) || SIZE_PRESETS[sizeSelect.value] || 1;
  const spacing = parseInt(spacingInput.value,10) || 1;
  const out = render(text, draw, scale, spacing);
  // show output without attribution
  outputEl.textContent = out;

  // prepare downloadable file content with attribution appended
  const outWithAttribution = out + "\n" + ATTRIBUTION_LINE + "\n";
  const blob = new Blob([outWithAttribution], {type: "text/plain"});
  const url = URL.createObjectURL(blob);
  downloadLink.href = url;
}

renderBtn.addEventListener("click", doRender);

copyBtn.addEventListener("click", async () => {
  try {
    const baseText = outputEl.textContent || "";
    const textToCopy = baseText + "\n" + ATTRIBUTION_LINE + "\n";
    await navigator.clipboard.writeText(textToCopy);
    copyBtn.textContent = "Copied!";
    setTimeout(()=>copyBtn.textContent="Copy",900);
  } catch (e) {
    copyBtn.textContent = "Copy failed";
    setTimeout(()=>copyBtn.textContent="Copy",1200);
  }
});

// initial render
doRender();
